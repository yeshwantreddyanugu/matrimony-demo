<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Add Profile - Admin Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Additional styles for the matrimony form */
        .profile-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
            margin-right: 20px;
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 80px;
        }

        #tribe-select {
            height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }

        #tribe-select option {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #2980b9;
        }

        .photo-upload-container {
            margin: 20px 0;
        }

        .photo-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: contain;
            /* Changed from 'cover' */
            border: 3px solid #3498db;
            display: block;
            margin: 15px auto;
            background-color: #fff;
            /* Optional: shows behind transparent parts */
        }


        .upload-btn {
            display: inline-block;
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .upload-btn:hover {
            background-color: #2980b9;
        }

        #photoFile {
            display: none;
        }

        .photo-info {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>Dashboard</h2>
            <ul>
                <li><a href="home.html"><i class="fas fa-home"></i><span> Home</span></a></li>
                <li class="active"><a href="add-profile.html"><i class="fas fa-user-plus"></i><span> Add
                            Profile</span></a></li>
                <li><a href="view-profiles.html"><i class="fas fa-users"></i><span> View/Edit Profiles</span></a></li>
                <li><a href="enquiries.html"><i class="fas fa-question-circle"></i><span> Manage Enquiries</span></a>
                </li>
                <li><a href="activeStatus.html"><i class="fas fa-chart-line"></i><span> Active Users</span></a></li>
                <!-- <li><a href="settings.html"><i class="fas fa-cog"></i><span> Settings</span></a></li> -->
                <li><a href="user.html"><i class="fas fa-user-cog"></i><span> Users</span></a></li>
                <li><a href="addBanner.html"><i class="fa-solid fa-images"></i><span> Add Banner</span></a></li>
                <li><a href="viewBanner.html"><i class="fa-brands fa-joget"></i><span> View Banner</span></a></li>
                <li><a href="logout.html"><i class="fas fa-sign-out-alt"></i><span> Logout</span></a></li>
            </ul>
        </div>


        <!-- Main Content -->
        <div class="main-content">
            <h1>Matrimony Profile Entry</h1>

            <form class="profile-form" id="matrimonyForm">

                <div class="form-section">
                    <h3>Profile Photo</h3>
                    <div class="photo-upload-container">
                        <img id="photoPreview" class="photo-preview" src="https://via.placeholder.com/150"
                            alt="Profile Photo Preview">
                        <label for="photoFile" class="upload-btn">Choose Photo</label>
                        <input type="file" id="photoFile" name="photo" accept="image/*">
                        <div class="photo-info">Max size: 2MB | Formats: JPG, PNG</div>
                    </div>



                </div>


                <div class="form-section">
                    <h3>Profile Details</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="caste"> Caste: <span style="color: red;">*</span></label>
                            <select id="caste" name="caste" required>


                                <option value="Besta – Fishermen">Besta – Fishermen</option>
                                <option value="Goud">Goud</option>
                                <option value="Kurma">Kurma</option>
                                <option value="Kamma">Kamma</option>
                                <option value="Komatala-Vysya">Komatala / Vysya</option>
                                <option value="Madiga (Christian)">Madiga (Christian)</option>
                                <option value="Madiga (Hindu)">Madiga (Hindu)</option>
                                <option value="Mala (Christian)">Mala (Christian)</option>
                                <option value="Mala (Hindu)">Mala (Hindu)</option>
                                <option value="Mangali">Mangali</option>
                                <option value="Mudiraj-Mutrasi">Mudiraj / Mutrasi</option>
                                <option value="Munnur Kapu">Munnur Kapu</option>
                                <option value="Padmashali">Padmashali</option>
                                <option value="Perika">Perika</option>
                                <option value="Rajaka">Rajaka</option>
                                <option value="Reddy">Reddy</option>
                                <option value="Velama">Velama</option>
                                <option value="Yadav-Golla">Yadav / Golla</option>
                                <option value="Muslim">Muslim</option>
                            </select>



                        </div>


                        <div class="form-group">
                            <label for="relationship"> Relationship: <span style="color: red;">*</span></label>
                            <select id="relationship" name="relationship" required>
                                <option value="">Select</option>
                                <option value="Bride">Bride</option>
                                <option value="Groom">Groom</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="name"> Name of the girl/boy: <span style="color: red;">*</span></label>
                            <input type="text" id="name" name="name" required>
                        </div>
                    </div>





                    <div class="form-row">
                        <div class="form-group">
                            <label for="dob"> Date of Birth: <span style="color: red;">*</span></label>
                            <input type="date" id="dob" name="dob" required>
                        </div>


                        <div class="form-group">
                            <label for="height">Height(in ft): <span style="color: red;">*</span></label>
                            <select id="height" name="height" required>
                                <option value="3'0&quot;">3'0"</option>
                                <option value="3'1&quot;">3'1"</option>
                                <option value="3'2&quot;">3'2"</option>
                                <option value="3'3&quot;">3'3"</option>
                                <option value="3'4&quot;">3'4"</option>
                                <option value="3'5&quot;">3'5"</option>
                                <option value="3'6&quot;">3'6"</option>
                                <option value="3'7&quot;">3'7"</option>
                                <option value="3'8&quot;">3'8"</option>
                                <option value="3'9&quot;">3'9"</option>
                                <option value="3'10&quot;">3'10"</option>
                                <option value="3'11&quot;">3'11"</option>
                                <option value="4'0&quot;">4'0"</option>
                                <option value="4'1&quot;">4'1"</option>
                                <option value="4'2&quot;">4'2"</option>
                                <option value="4'3&quot;">4'3"</option>
                                <option value="4'4&quot;">4'4"</option>
                                <option value="4'5&quot;">4'5"</option>
                                <option value="4'6&quot;">4'6"</option>
                                <option value="4'7&quot;">4'7"</option>
                                <option value="4'8&quot;">4'8"</option>
                                <option value="4'9&quot;">4'9"</option>
                                <option value="4'10&quot;">4'10"</option>
                                <option value="4'11&quot;">4'11"</option>
                                <option value="5'0&quot;">5'0"</option>
                                <option value="5'1&quot;">5'1"</option>
                                <option value="5'2&quot;">5'2"</option>
                                <option value="5'3&quot;">5'3"</option>
                                <option value="5'4&quot;">5'4"</option>
                                <option value="5'5&quot;">5'5"</option>
                                <option value="5'6&quot;">5'6"</option>
                                <option value="5'7&quot;">5'7"</option>
                                <option value="5'8&quot;">5'8"</option>
                                <option value="5'9&quot;">5'9"</option>
                                <option value="5'10&quot;">5'10"</option>
                                <option value="5'11&quot;">5'11"</option>
                                <option value="6'0&quot;">6'0"</option>
                                <option value="6'1&quot;">6'1"</option>
                                <option value="6'2&quot;">6'2"</option>
                                <option value="6'3&quot;">6'3"</option>
                                <option value="6'4&quot;">6'4"</option>
                                <option value="6'5&quot;">6'5"</option>
                                <option value="6'6&quot;">6'6"</option>
                                <option value="6'7&quot;">6'7"</option>
                                <option value="6'8&quot;">6'8"</option>
                                <option value="6'9&quot;">6'9"</option>
                                <option value="6'10&quot;">6'10"</option>
                                <option value="6'11&quot;">6'11"</option>
                                <option value="7'0&quot;">7'0"</option>
                            </select>

                        </div>



                    </div>

                    <div class="form-row">






                        <!-- Added Colour Field -->
                        <div class="form-group">
                            <label for="colour"> Colour:</label>
                            <select id="colour" name="colour">
                                <option value="">-- Select Skin Tone --</option>
                                <option value="Very Light">Very Light – Pale skin, often looks white</option>
                                <option value="Light">Light – Fair skin, with pinkish or yellowish tones</option>
                                <option value="Medium Light">Medium Light – Slightly darker than light, but still pale
                                </option>
                                <option value="Olive">Olive – Skin with a greenish or yellowish tint</option>
                                <option value="Tan">Tan – Light brown, like skin after being in the sun</option>
                                <option value="Brown">Brown – Medium brown skin</option>
                                <option value="Caramel">Caramel – Light to medium brown, with a golden or warm tone
                                </option>
                                <option value="Dark Brown">Dark Brown – Rich brown skin</option>
                                <option value="Very Dark">Very Dark – Deep brown or black skin, often cool-toned
                                </option>
                            </select>
                        </div>

                    </div>


                    <div class="form-row">
                        <div class="form-group">
                            <label for="tribe"> Tribe:</label>
                            <select id="tribe-select" name="tribe" disabled multiple>
                                <option value="Motati">1. Motati</option>
                                <option value="Velanati">2. Velanati</option>
                                <option value="Morasa">3. Morasa</option>
                                <option value="Nereti">4. Nereti</option>
                                <option value="Ayodhya">5. Ayodhya</option>
                                <option value="Panta">6. Panta</option>
                                <option value="Pongalinati">7. Pongalinati</option>
                                <option value="Pakanati">8. Pakanati</option>
                                <option value="Bhumanci">9. Bhumanci</option>
                                <option value="Kuriceti">10. Kuriceti</option>
                                <option value="Munnuti">11. Munnuti</option>
                                <option value="Desati">12. Desati</option>
                                <option value="Kammapuri">13. Kammapuri</option>
                                <option value="Gandikota">14. Gandikota</option>
                                <option value="Kammapuri">15. Kammapuri</option>
                                <option value="Gona">16. Gona</option>
                                <option value="Chittepu">17. Chittepu</option>
                                <option value="Kunchedugu">18. Kunchedugu</option>
                                <option value="Gajula">19. Gajula</option>
                                <option value="Konide">20. Konide</option>
                                <option value="Pedakanti">21. Pedakanti</option>
                                <option value="Gudati">22. Gudati</option>
                                <option value="Gonugunta">23. Gonugunta</option>
                                <option value="Desuri">24. Desuri</option>
                                <option value="Nanugunda">25. Nanugunda</option>
                                <option value="Neravatu">26. Neravatu</option>
                                <option value="Palle">27. Palle</option>
                                <option value="Balija">28. Balija</option>
                                <option value="Bhusa">29. Bhusa</option>
                                <option value="Togarcrdu">30. Togarcrdu</option>
                                <option value="Yadlanu">31. Yadlanu</option>
                                <option value="Renati">32. Renati</option>
                                <option value="Laligunda">33. Laligunda</option>
                                <option value="Sajjana">34. Sajjana</option>
                                <option value="Sadara">35. Sadara</option>
                                <option value="Aritaku">36. Aritaku</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Education & Career</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="education">🎓Education: <span style="color: red;">*</span></label>
                            <select id="education" name="education" required>
                                <option value="">-- Select Education --</option>
                                <option value="No Formal Education">No Formal Education</option>
                                <option value="Primary School">Primary School (1st–5th Class)</option>
                                <option value="High School">High School (6th–10th Class)</option>
                                <option value="Intermediate">Intermediate / 12th Standard</option>
                                <option value="ITI/Polytechnic/Diploma">ITI / Polytechnic / Diploma</option>
                                <option value="Bachelor’s Degree">Bachelor’s Degree – BA / BSc / BCom</option>
                                <option value="B.Tech/BE">B.Tech / BE</option>
                                <option value="BBA/BBM">BBA / BBM</option>
                                <option value="BCA">BCA</option>
                                <option value="LLB">LLB</option>
                                <option value="MBBS/BDS/BAMS/BHMS">MBBS / BDS / BAMS / BHMS</option>
                                <option value="Nursing">Nursing</option>
                                <option value="B.Ed/D.Ed">B.Ed / D.Ed</option>
                                <option value="CA/ICWA/CS">CA / ICWA / CS</option>
                                <option value="BFA">Bachelor of Fine Arts (BFA)</option>
                                <option value="BHM">Bachelor of Hotel Management (BHM)</option>
                                <option value="Other Bachelor's Degree">Other Bachelor's Degree</option>
                                <option value="Master’s Degree">Master’s Degree – MA / MSc / MCom</option>
                                <option value="M.Tech/ME">M.Tech / ME</option>
                                <option value="MBA/PGDM">MBA / PGDM</option>
                                <option value="MCA">MCA</option>
                                <option value="M.Ed">M.Ed</option>
                                <option value="LLM">LLM</option>
                                <option value="MD/MS/MDS">MD / MS / MDS</option>
                                <option value="Ph.D/Doctorate">Ph.D / Doctorate</option>
                                <option value="Preparing for Govt. Exams">Preparing for Govt. Exams</option>
                                <option value="Other/Not Mentioned">Other / Not Mentioned</option>
                            </select>
                        </div>


                        <div class="form-group">
                            <label for="occupation">💼Occupation / Business: <span style="color: red;">*</span></label>
                            <select id="occupation" name="occupation" required>
                                <option value="">-- Select Occupation --</option>
                                <option value="Not Working">Not Working</option>
                                <option value="Student">Student</option>
                                <option value="Farmer/Agriculture">Farmer / Agriculture</option>
                                <option value="Daily Wage Worker">Daily Wage Worker / Labour</option>
                                <option value="Driver">Driver (Auto/Taxi/Truck)</option>
                                <option value="Private Employee">Private Employee</option>
                                <option value="Government Employee">Government Employee</option>
                                <option value="Police/Army/Defense">Police / Army / Defense</option>
                                <option value="Teacher">Teacher</option>
                                <option value="Lecturer/Professor">Lecturer / Professor</option>
                                <option value="Software/IT Professional">Software / IT Professional</option>
                                <option value="Engineer">Engineer (Civil/Mechanical/etc.)</option>
                                <option value="Doctor/Nurse/Medical Field">Doctor / Nurse / Medical Field</option>
                                <option value="Business Owner">Business Owner</option>
                                <option value="Shop Owner/Self-Employed">Shop Owner / Self-Employed</option>
                                <option value="Marketing/Sales Executive">Marketing / Sales Executive</option>
                                <option value="Bank Employee">Bank Employee</option>
                                <option value="Chartered Accountant/Auditor">Chartered Accountant / Auditor</option>
                                <option value="Advocate/Legal Professional">Advocate / Legal Professional</option>
                                <option value="Actor/Artist/Musician">Actor / Artist / Musician</option>
                                <option value="Fashion Designer/Tailor">Fashion Designer / Tailor</option>
                                <option value="Chef/Cook">Chef / Cook</option>
                                <option value="Real Estate Agent">Real Estate Agent</option>
                                <option value="Politician/Panchayat Leader">Politician / Panchayat Leader</option>
                                <option value="Scientist/Researcher">Scientist / Researcher</option>
                                <option value="Media/Journalist">Media / Journalist</option>
                                <option value="Technician/Mechanic">Technician / Mechanic</option>
                                <option value="Electrician/Plumber/Carpenter">Electrician / Plumber / Carpenter</option>
                                <option value="NGO/Social Worker">NGO / Social Worker</option>
                                <option value="Freelancer/Online Business">Freelancer / Online Business</option>
                                <option value="Abroad/Working Overseas">Abroad / Working Overseas</option>
                                <option value="Retired">Retired</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>


                        <div class="form-group">
                            <label for="income"> Monthly Income: <span style="color: red;">*</span></label>
                            <input type="text" id="income" name="income" required>
                        </div>
                    </div>



                </div>



                <div class="form-section">
                    <h3>Location Details</h3>

                    <div class="form-row">

                        <div class="form-group">
                            <label for="state"> State: <span style="color: red;">*</span></label>
                            <select id="state" name="state" required onchange="updateDistricts()">
                                <option value="">-- Select State --</option>
                                <option value="Telangana">Telangana</option>
                                <option value="Andhra Pradesh">Andhra Pradesh</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="district">District: <span style="color: red;">*</span></label>
                            <select id="district" name="district" required>
                                <option value="">-- Select District --</option>
                            </select>
                        </div>

                        <script>
                            const districts = {
                                "Telangana": [
                                    "Hyderabad", "Khammam", "Nalgonda", "Warangal", "Nizamabad", "Mahabubnagar", "Medak",
                                    "Karimnagar", "Adilabad", "Jagtial", "Kothagudem", "Suryapet", "Mahabubabad", "Rajanna Sircilla",
                                    "Peddapalli", "Kamareddy", "Wanaparthy", "Nagarkurnool", "Vikarabad", "Jayashankar-Bhupalapally",
                                    "Mancherial", "Manuguru", "Sangareddy", "Medchal-Malkajgiri"
                                ],
                                "Andhra Pradesh": [
                                    "Anantapur", "Chittoor", "East Godavari", "Guntur", "Krishna", "Kurnool", "Prakasam", "Srikakulam",
                                    "Visakhapatnam", "West Godavari", "Kadapa (YSR)", "Nellore", "Vizianagaram", "Nandyal", "Bapatla",
                                    "Rajamahendravaram", "Peddapalli"
                                ]
                            };

                            function updateDistricts() {
                                const stateSelect = document.getElementById("state");
                                const districtSelect = document.getElementById("district");
                                const selectedState = stateSelect.value;

                                // Clear previous options
                                districtSelect.innerHTML = '<option value="">-- Select District --</option>';

                                if (districts[selectedState]) {
                                    districts[selectedState].forEach(district => {
                                        const option = document.createElement("option");
                                        option.value = district;
                                        option.textContent = district;
                                        districtSelect.appendChild(option);
                                    });
                                }
                            }
                        </script>

                    </div>
                </div>







                <div class="form-row">
                    <button type="submit" class="btn">Save Profile</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        const API_BASE_URL = 'https://apimatrimony.lytortech.com/api/profiles';

        document.addEventListener('DOMContentLoaded', function () {



            // Check authentication status
            if (sessionStorage.getItem('isLoggedIn') !== 'true' ||
                localStorage.getItem('isLoggedIn') !== 'true') {
                window.location.replace('index.html');
                return;
            }

            // Prevent back navigation to login page
            window.history.pushState(null, null, window.location.href);
            window.onpopstate = function () {
                window.history.go(1);
            };






            // DOM Elements
            const form = document.getElementById('matrimonyForm');
            const casteInput = document.getElementById('caste');
            const tribeSelect = document.getElementById('tribe-select');
            const photoFile = document.getElementById('photoFile');
            const photoPreview = document.getElementById('photoPreview');
            const submitBtn = form.querySelector('button[type="submit"]');

            // State variables
            let editMode = false;
            let editProfileId = null;
            let editData = null;

            // Initialize form based on edit mode
            function initializeForm() {
                // Photo upload handling
                photoFile.addEventListener('change', handlePhotoUpload);

                // Caste-Tribe relationship
                casteInput.addEventListener('input', handleCasteChange);

                // Check for edit mode
                if (window.location.search.includes('edit=true')) {
                    setupEditMode();
                }

                // Form submission
                form.addEventListener('submit', handleFormSubmit);
            }

            // Handle photo upload
            function handlePhotoUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                // Validate file type
                const validTypes = ['image/jpeg', 'image/png'];
                if (!validTypes.includes(file.type)) {
                    alert('Please upload a JPG or PNG image');
                    photoFile.value = '';
                    return;
                }

                // Validate file size
                if (file.size > 2 * 1024 * 1024) {
                    alert('Image must be less than 2MB');
                    photoFile.value = '';
                    return;
                }

                // Preview image
                const reader = new FileReader();
                reader.onload = function (event) {
                    photoPreview.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }

            // Handle caste selection change
            function handleCasteChange() {
                const isOC = this.value.toLowerCase() === 'reddy';
                tribeSelect.disabled = !isOC;
                if (!isOC) tribeSelect.selectedIndex = -1;
            }

            // Setup edit mode
            function setupEditMode() {
                const editData = JSON.parse(localStorage.getItem('editProfileData'));
                if (!editData) return;

                console.log('Initializing edit mode with data:', editData);
                editMode = true;
                editProfileId = editData.id;

                // Field mappings
                const fieldMappings = {
                    'father_name': 'fatherName',
                    'father_occupation': 'fatherOccupation',
                    'mother_name': 'motherName',
                    'mother_occupation': 'motherOccupation',
                    'income': 'monthlyIncome',
                    'native_place': 'nativePlace',
                    'current_residence': 'currentResidence',
                    'dob': 'dateOfBirth',
                    'name': 'name',
                    'education': 'education',
                    'occupation': 'occupation',
                    'relationship': 'relationship',
                    'height': 'height',
                    'state': 'state',
                    'district': 'district',
                    'colour': 'color',
                    'caste': 'caste'
                };

                // Populate fields
                for (const [frontendField, backendField] of Object.entries(fieldMappings)) {
                    const field = document.querySelector(`[name="${frontendField}"]`);
                    if (field && editData[backendField] !== null && editData[backendField] !== undefined) {
                        field.value = editData[backendField];
                    }
                }

                // Handle date and time
                if (editData.dateOfBirth) {
                    const [datePart, timePart] = editData.dateOfBirth.split('T');
                    const dateField = document.querySelector('[name="dob"]');
                    if (dateField) dateField.value = datePart;
                }

                if (editData.state) {
                    const stateField = document.querySelector('[name="state"]');
                    if (stateField) {
                        stateField.value = editData.state;
                        updateDistricts(); // Populate districts for this state
                    }
                }

                if (editData.district) {
                    const districtField = document.querySelector('[name="district"]');
                    if (districtField) {
                        // Small delay to ensure districts are populated
                        setTimeout(() => {
                            districtField.value = editData.district;
                        }, 100); // 100ms is usually enough
                    }
                }


                // Handle tribe (multi-select)
                if (editData.tribe) {
                    const tribeOptions = tribeSelect.options;
                    for (let i = 0; i < tribeOptions.length; i++) {
                        if (tribeOptions[i].value === editData.tribe) {
                            tribeOptions[i].selected = true;
                            tribeSelect.disabled = false;
                            break;
                        }
                    }
                }

                // Handle photo preview
                if (editData.imageUrl) {
                    console.log('Loading image from:', editData.imageUrl);
                    photoPreview.src = editData.imageUrl;
                } else {
                    photoPreview.src = 'https://via.placeholder.com/150'; // fallback
                }
            }




            // Handle form submission
            async function handleFormSubmit(e) {
                e.preventDefault();

                try {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Saving...';

                    const formData = new FormData(form);
                    const requestFormData = new FormData();

                    if (editMode) {
                        requestFormData.append('id', editProfileId);
                    }

                    const backendFieldMappings = {
                        'father_name': 'fatherName',
                        'father_occupation': 'fatherOccupation',
                        'mother_name': 'motherName',
                        'mother_occupation': 'motherOccupation',
                        'income': 'monthlyIncome',
                        'native_place': 'nativePlace',
                        'current_residence': 'currentResidence',
                        'dob': 'dateOfBirth'
                    };

                    // 🔥 Validate that a photo is selected (or exists in edit)
                    if (!photoFile.files[0] && !(editMode && editData?.imageUrl)) {
                        alert('📸 Please upload a profile photo before submitting. If an existing photo is present, kindly re-upload it to confirm.');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Save Profile';
                        return;
                    }

                    // Append all form data except image
                    formData.forEach((value, key) => {
                        if (key === 'dob' && value) {
                            requestFormData.append('dateOfBirth', `${value}T00:00`);
                        } else if (key !== 'photo') {
                            const backendFieldName = backendFieldMappings[key] || key;
                            requestFormData.append(backendFieldName, value);
                        }
                    });

                    // 🔥 Enhanced Image Handling
                    if (photoFile.files[0]) {
                        // New image uploaded
                        requestFormData.append('image', photoFile.files[0]);
                    } else if (editMode && editData?.imageUrl) {
                        // Preserve existing image in edit mode
                        const imageName = editData.imageUrl.split('/').pop();
                        requestFormData.append('existingImagePath', imageName);
                    }

                    const url = editMode ? `${API_BASE_URL}/update/profile` : API_BASE_URL;
                    const method = editMode ? 'PUT' : 'POST';

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                        },
                        body: requestFormData
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    showSuccessMessage();

                } catch (error) {
                    console.error('Error:', error);
                    alert('Error: ' + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Save Profile';
                }
            }



            // Show success message and redirect
            function showSuccessMessage() {
                alert(`Profile ${editMode ? 'updated' : 'created'} successfully!`);
                localStorage.removeItem('editProfileData');
                window.location.href = 'view-profiles.html';
            }

            // Initialize the form
            initializeForm();
        });
    </script>


</body>

</html>