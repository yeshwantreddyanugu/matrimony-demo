<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Enquiries - Admin Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 0;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            background-color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background-color: #0f173f;
            color: white;
            font-weight: 500;
        }

        tr:hover {
            background-color: #f5f7fa;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            min-width: 80px;
        }

        .btn-approved {
            background-color: #2ecc71;
            color: white;
        }

        .btn-rejected {
            background-color: #e74c3c;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>Dashboard</h2>
            <ul>
                <li><a href="home.html"><i class="fas fa-home"></i><span> Home</span></a></li>
                <li><a href="add-profile.html"><i class="fas fa-user-plus"></i><span> Add Profile</span></a></li>
                <li><a href="view-profiles.html"><i class="fas fa-users"></i><span> View/Edit Profiles</span></a></li>
                <li class="active"><a href="enquiries.html"><i class="fas fa-question-circle"></i><span> Manage Enquiries</span></a></li>
                <li><a href="activeStatus.html"><i class="fas fa-chart-line"></i><span> Active Users</span></a></li>
                <!-- <li><a href="settings.html"><i class="fas fa-cog"></i><span> Settings</span></a></li> -->
                <li><a href="user.html"><i class="fas fa-user-cog"></i><span> Users</span></a></li>
                <li><a href="addBanner.html"><i class="fa-solid fa-images"></i><span> Add Banner</span></a></li>
                <li><a href="viewBanner.html"><i class="fa-brands fa-joget"></i><span> View Banner</span></a></li>
                <li><a href="logout.html"><i class="fas fa-sign-out-alt"></i><span> Logout</span></a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <h1>Manage Enquiries</h1>

            <div id="loadingIndicator" class="loading">Loading enquiries...</div>
            <table id="enquiriesTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Number</th>
                        <th>Age</th>
                        <th>Gender</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="enquiriesTableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Base URL for your backend API
        const API_BASE_URL = 'https://4ddd-2401-4900-889d-8d9e-b4a5-2d10-4a34-b143.ngrok-free.app';

        // Fetch all forms from backend
        async function fetchForms() {
            try {
                showLoading();
                const response = await fetch(`${API_BASE_URL}/api/forms/all/forms`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'ngrok-skip-browser-warning': 'true'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Successfully fetched forms:', data);
                return data;
            } catch (error) {
                console.error('Error in fetchForms:', error);
                showToast('Failed to load forms. Please try again.', 'error');
                return [];
            } finally {
                hideLoading();
            }
        }

        // Render forms in table with debug logging
        function renderForms(forms) {
            console.log("Rendering forms with raw data:", JSON.stringify(forms, null, 2)); // Detailed log

            const tableBody = document.getElementById('enquiriesTableBody');
            tableBody.innerHTML = '';

            if (forms.length === 0) {
                tableBody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center">No enquiries found</td>
            </tr>
        `;
                return;
            }

            forms.forEach(form => {
                console.log("Processing form:", form); // Debug log

                // Check both possible property names (isApproved and approved)
                const isApproved = form.isApproved !== undefined ? Boolean(form.isApproved) : Boolean(form.approved);

                console.log(`Approval status for ${form.name}:`, {
                    isApproved: form.isApproved,
                    approved: form.approved,
                    evaluated: isApproved
                }); // Debug log

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${form.name || 'N/A'}</td>
            <td>${form.number || 'N/A'}</td>
            <td>${form.age || 'N/A'}</td>
            <td>${form.gender || 'N/A'}</td>
            <td>
                <button 
                    class="btn ${isApproved ? 'btn-approved' : 'btn-rejected'}" 
                    onclick="toggleApprovalStatus('${form.uid}', '${form.id}', ${!isApproved})"
                >
                    ${isApproved ? 'Approved' : 'Rejected'}
                </button>
            </td>
        `;
                tableBody.appendChild(row);
            });

            document.getElementById('enquiriesTable').style.display = 'table';
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        // Toggle approval status with more detailed logging
        async function toggleApprovalStatus(uid, id, newStatus) {
            console.log(`Toggling status for ${uid} to ${newStatus}`); // Debug log

            if (confirm(`Are you sure you want to ${newStatus ? 'approve' : 'reject'} this enquiry?`)) {
                try {
                    showLoading();
                    const response = await fetch(`${API_BASE_URL}/api/forms/status/${uid}/${newStatus}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log("PUT response:", result); // Debug log
                        showToast(`Enquiry ${newStatus ? 'approved' : 'rejected'} successfully`);
                        loadForms(); // This should trigger a fresh render
                    } else {
                        const errorText = await response.text();
                        console.error("PUT error:", errorText); // Debug log
                        throw new Error(errorText || `Failed to ${newStatus ? 'approve' : 'reject'} enquiry`);
                    }
                } catch (error) {
                    console.error('Error toggling approval status:', error);
                    showToast(error.message || 'Error updating status', 'error');
                } finally {
                    hideLoading();
                }
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            // Implement your toast notification logic here
            console.log(`${type}: ${message}`);
            alert(`${type}: ${message}`);
        }

        // Show loading indicator
        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('enquiriesTable').style.display = 'none';
        }

        // Hide loading indicator
        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        // Load and display forms with debug logging
        async function loadForms() {
            console.log("Loading forms..."); // Debug log
            const forms = await fetchForms();
            console.log("Forms loaded:", forms); // Debug log
            renderForms(forms);
        }


        // Initialize on page load
        document.addEventListener('DOMContentLoaded', loadForms);
    </script>
</body>

</html>